meta {
  name: Opt Out of Coding Out
  type: http
  seq: 9
}

post {
  url: {{base_url}}/accounts/self-assessment/{{nino}}/{{taxYear}}/collection/tax-code/coding-out/opt-out
  body: json
  auth: none
}

headers {
  Accept: application/vnd.hmrc.4.0+json
  Authorization: Bearer {{access_token}}
}

script:pre-request {
  // Add Gov-Test-Scenario header if set
  const scenario = bru.getVar('Gov-Test-Scenario');
  if (scenario && scenario.trim() !== '') {
    req.setHeader('Gov-Test-Scenario', scenario);
  }
}

tests {
  test("Should return success", function() {
    expect(res.status).to.be.oneOf([200, 201, 204]);
  });
}

docs {
  ## Opt Out of Coding Out
  
  This endpoint enables a specified customer (identified by a National Insurance number) and tax year to opt out of coding out. Opt-out status can be changed up to and including 30 December following the end of the specified tax year. Opt-out status cannot be changed after the customer has made a final declaration for the specified tax year.
    
### Test data
Scenario simulation using Gov-Test-Scenario headers is only available in the sandbox environment.

| Header Value (Gov-Test-Scenario) | Scenario                                                                                                                                                 |
|----------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------|
| N/A - DEFAULT                    | Simulates a successful response with latest values.                                                                                                      |
| BUSINESS_PARTNER_NOT_EXIST       | Simulates a scenario where the NINO is valid but is not registered with ITSD as a business partner.                                                      |
| ITSA_CONTRACT_OBJECT_NOT_EXIST   | Simulates a scenario where the NINO is valid and is registered with ITSD as a business partner, but the ITSA contract object does not exist for the NINO.|
| ALREADY_OPTED_OUT                | Simulates a scenario where the customer cannot be opted out because they are already opted out.                                                          |
| STATEFUL                         | Performs a stateful Opt Out of Coding Out.                                                                                                               |

  
  API: Self Assessment Accounts
}
