meta {
  name: Trigger a Self Assessment Tax Calculation [test only]
  type: http
  seq: 1
}

post {
  url: {{base_url}}/individuals/calculations/{{nino}}/self-assessment/{{taxYear}}/trigger/{{calculationType}}
  body: json
  auth: none
}

headers {
  Accept: application/vnd.hmrc.8.0+json
  Authorization: Bearer {{access_token}}
}

script:pre-request {
  // Add Gov-Test-Scenario header if set
  const scenario = bru.getVar('Gov-Test-Scenario');
  if (scenario && scenario.trim() !== '') {
    req.setHeader('Gov-Test-Scenario', scenario);
  }
}

tests {
  test("Should return success", function() {
    expect(res.status).to.be.oneOf([200, 201, 204]);
  });
}

docs {
  ## Trigger a Self Assessment Tax Calculation [test only]
  
  This endpoint allows the user to trigger a self assessment tax calculation for a given tax year. 
It should be called whenever income data is updated through a periodic or annual endpoint. 
To trigger a final declaration self assessment tax calculation,
you must set the calculationType path parameter to intent-to-finalise.

A National Insurance number and tax year must be provided. 

The tax calculation process is asynchronous, so it is recommended you wait at least 5 seconds 
before calling the retrieval endpoint. 
The result of the calculation can be seen using the 
“Retrieve a Self Assessment Tax Calculation” endpoint.

### Test data
Scenario simulations using `Gov-Test-Scenario` headers is only available in the sandbox environment.

| Header Value (Gov-Test-Scenario) | Scenario                                                                                           |
|----------------------------------|----------------------------------------------------------------------------------------------------|
| N/A - DEFAULT                    | Simulates success response.                                                                        |
| NO_INCOME_SUBMISSIONS_EXIST      | Simulates the scenario where no income submissions exist for the tax year.                       |
| FINAL_DECLARATION_RECEIVED       | Simulates the scenario where a final declaration has already been received.                       |
| INCOME_SOURCES_CHANGED           | Simulates the scenario where income sources data has changed.                                     |
| RECENT_SUBMISSIONS_EXIST         | Simulates the scenario where more recent submissions exist.                                       |
| RESIDENCY_CHANGED                | Simulates the scenario where residency has changed.                                               |
| CALCULATION_IN_PROGRESS          | Simulates the scenario where a calculation is in progress.                                        |
| BUSINESS_VALIDATION_FAILURE      | Simulates the scenario where there is a generic business validation rule failure.                |
| TAX_YEAR_NOT_ENDED               | Simulates the scenario where a triggering for a final declaration is performed before the tax year has ended. |

  
  API: Individual Calculations
}
