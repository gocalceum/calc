meta {
  name: Submit a Self Assessment Final Declaration [test only]
  type: http
  seq: 4
}

post {
  url: {{base_url}}/individuals/calculations/{{nino}}/self-assessment/{{taxYear}}/{{calculationId}}/{{calculationType}}
  body: json
  auth: none
}

headers {
  Accept: application/vnd.hmrc.8.0+json
  Authorization: Bearer {{access_token}}
}

script:pre-request {
  // Add Gov-Test-Scenario header if set
  const scenario = bru.getVar('Gov-Test-Scenario');
  if (scenario && scenario.trim() !== '') {
    req.setHeader('Gov-Test-Scenario', scenario);
  }
}

tests {
  test("Should return success", function() {
    expect(res.status).to.be.oneOf([200, 201, 204]);
  });
}

docs {
  ## Submit a Self Assessment Final Declaration [test only]
  
  This endpoint allows the developer to submit a final declaration for a tax year by agreeing to the HMRC's tax calculation. 

A National Insurance number, tax year and calculation ID must be provided.

### Test data
Scenario simulations using `Gov-Test-Scenario` headers is only available in the sandbox environment.

| Header Value (Gov-Test-Scenario)   | Scenario                                                                           |
|------------------------------------|------------------------------------------------------------------------------------|
| N/A - DEFAULT                      | Simulates success response.                                                        |
| OUTSIDE_AMENDMENT_WINDOW           | Simulates the scenario where the request cannot be completed as it is outside the amendment window. |
| FINAL_DECLARATION_IN_PROGRESS      | Simulates the scenario where there is a calculation in progress for the tax year.  |
| FINAL_DECLARATION_RECEIVED         | Simulates the scenario where a final declaration has already been received.        |
| FINAL_DECLARATION_TAX_YEAR         | Simulates the scenario where the final declaration cannot be submitted until after the end of the tax year. |
| INCOME_SOURCES_CHANGED             | Simulates the scenario where information relating to an income source has changed. |
| INCOME_SOURCES_INVALID             | Simulates the scenario where a valid income source cannot be found.                |
| NO_INCOME_SUBMISSIONS_EXIST        | Simulates the scenario where no income submissions exist.                          |
| RECENT_SUBMISSIONS_EXIST           | Simulates the scenario where more recent submissions exist.                        |
| RESIDENCY_CHANGED                  | Simulates the scenario where residency has changed.                                 |
| SUBMISSION_FAILED                  | Simulates the scenario where a submission has failed.                               |
| TAX_YEAR_NOT_SUPPORTED             | Simulates the scenario where the specified tax year is not supported.              |
| NOT_FOUND                          | Simulates the scenario where the supplied income source could not be found.        |

  
  API: Individual Calculations
}
